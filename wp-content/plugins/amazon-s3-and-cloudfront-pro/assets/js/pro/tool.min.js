!function(a,b){as3cfpro.tool={ID:"",timerCount:0,elapsedInterval:0,$counterDisplay:"",nextStepInProcess:!1,doingAjax:!1,processPaused:!1,nonFatalErrors:!1,processError:!1,processCompleted:!1,processCancelled:!1,currentlyProcessing:!1,itemsProcessed:!1,progressModalActive:!1,progressPercent:0,progressBytes:0,progressTotalBytes:0,progressCount:0,progressTotalCount:0,contentHeight:0,$progressContent:!1,$progressContentOriginal:!1,open:function(a){this.ID=a,as3cfpro.tool.openModal()},openFromURL:function(){for(var a=window.location.search.substring(1),b=a.split("&"),c=0;c<b.length;c++){var d=b[c].split("=");if("tool"===d[0])return void this.open(d[1])}},cloneViews:function(){this.$progressContentOriginal=a(".progress-content").clone(),a(".progress-content").remove()},animateProgressBars:function(){a(".as3cf-sidebar.pro .block .progress-bar-wrapper .progress-bar").each(function(){a(this).animate({width:a(this).parent().data("percentage")+"%"},1200)})},renderPieChart:function(){var b,c,d,e=100,f=[];b=a(".as3cf-sidebar.pro .pie-chart").data("percentage"),b>=100&&a(".as3cf-sidebar.pro .pie-chart ~ h4").addClass("completed"),b<1||b>99||(d=3.6*b,f[0]=e*Math.cos(Math.PI*d/180),f[1]=e*Math.sin(Math.PI*d/180),c="M0,0 L"+e+",0 A"+e+","+e+" 0 1,1 "+f[0]+","+f[1]+" Z",a(".as3cf-sidebar.pro .pie-chart ~ h4").removeClass("completed"),a(".as3cf-sidebar.pro .pie-chart svg path").attr("d",c))},openModal:function(){var b=a(document).height();a("body").append('<div id="overlay"></div>'),a("#overlay").height(b).css({position:"fixed",top:0,left:0,width:"100%","z-index":99999,display:"none"}),this.showProgressModal(),this.init(),a("#overlay").show()},init:function(){var c=this;this.currentlyProcessing=!0,this.doingAjax=!0,a.ajax({url:ajaxurl,type:"POST",dataType:"json",cache:!1,data:{action:this.getAjaxAction("initiate"),nonce:this.getAjaxNonce("initiate")},error:function(a,b,d){c.ajaxError(a,b,d)},success:function(a){if(!c.isError(a)){var d={bytes:0,files:0,total_bytes:0,total_files:0};"undefined"!=typeof a.progress&&b.extend(d,a.progress),c.nextStepInProcess={fn:c.calculateItemsRecursive,args:[a.blogs,d]},c.executeNextStep()}}})},showProgressModal:function(){this.$progressContent=this.$progressContentOriginal.clone(),this.$progressContent.find("h2.progress-title").html(this.getString("tool_title")),a("#overlay").after(this.$progressContent),this.contentHeight=this.$progressContent.outerHeight(),this.$progressContent.css("top","-"+this.contentHeight+"px").show().animate({top:"0px"}),this.progressModalActive=!0,a(".upload-controls .cancel").after('<img src="'+as3cfpro.spinnerUrl+'" alt="" class="upload-progress-ajax-spinner general-spinner" />'),this.setupCounter()},cancel:function(){this.processCancelled=!0,this.processPaused=!1,a(".upload-controls").fadeOut(),a(".upload-progress-ajax-spinner").show(),a(".progress-text").html(this.getString("completing_current_request")),!1===this.doingAjax&&this.executeNextStep()},pad:function(a,b,c){return c=c||"0",a+="",a.length>=b?a:new Array(b-a.length+1).join(c)+a},setupCounter:function(){this.timerCount=0,this.$counterDisplay=a(".timer"),this.elapsedInterval=setInterval(this.count,1e3)},count:function(){var a=as3cfpro.tool;a.timerCount=a.timerCount+1,a.displayCount()},displayCount:function(){var a=Math.floor(this.timerCount/3600)%24,b=Math.floor(this.timerCount/60)%60,c=this.timerCount%60,d=this.pad(a,2,0)+":"+this.pad(b,2,0)+":"+this.pad(c,2,0);this.$counterDisplay.html(d)},numberFormat:function(a){a+="";for(var b=a.split("."),c=b[0],d=b.length>1?"."+b[1]:"",e=/(\d+)(\d{3})/;e.test(c);)c=c.replace(e,"$1,$2");return c+d},sizeFormat:function(a){var b=1024,c=["kB","MB","GB","TB","PB","EB","ZB","YB"];if(a<b)return a+" B";var d=-1;do a/=b,d++;while(a>=b);return a.toFixed(1)+" "+c[d]},setPauseResumeButton:function(b){!0===this.processPaused?(this.processPaused=!1,this.doingAjax=!0,a(".upload-progress-ajax-spinner").show(),a(".pause-resume").html(this.getString("pause")),this.elapsedInterval=setInterval(this.count,1e3),this.executeNextStep()):(a(this).off(b),this.processPaused=!0,this.doingAjax=!1,a(".pause-resume").html(this.getString("pausing")).addClass("disabled")),this.updateProgressMessage()},updateProgress:function(b,c,d,e){this.progressBytes=d,this.progressTotalBytes=e,this.progressCount=b,this.progressTotalCount=c,e>0?this.progressPercent=Math.round(100*d/e):this.progressPercent=Math.round(100*this.progressCount/this.progressTotalCount),a(".progress-content .progress-bar").width(this.progressPercent+"%"),this.renderPieChart(),this.updateProgressMessage()},updateProgressMessage:function(){var b=this.getString("files_processed").replace("%1$d",this.progressCount).replace("%2$d",this.numberFormat(this.progressTotalCount)),c=this.progressPercent+"% "+this.getString("complete"),d="";this.progressTotalBytes>0&&as3cfpro.settings.tools[this.ID].show_file_size&&(d="("+this.sizeFormat(this.progressBytes)+" / "+this.sizeFormat(this.progressTotalBytes)+")"),a(".upload-progress").html(b),!1===this.processPaused?a(".progress-text").html(c+" "+d):a(".progress-text").html(this.getString("completing_current_request"))},getString:function(a){return void 0!==as3cfpro.strings[a]?as3cfpro.strings[a]:void 0!==as3cfpro.strings.tools[this.ID][a]?as3cfpro.strings.tools[this.ID][a]:""},getAjaxAction:function(a){return"as3cfpro_"+a+"_"+this.ID},getAjaxNonce:function(a){return as3cfpro.nonces[a+"_"+this.ID]},updateSidebar:function(){var b=this;a.ajax({url:ajaxurl,type:"POST",dataType:"json",cache:!1,data:{action:"as3cfpro_update_sidebar",nonce:as3cfpro.nonces.update_sidebar,tool:b.ID},success:function(c){!0===c.success&&"undefined"!=typeof c.data&&(a.each(c.data,function(a,c){"undefined"!=typeof c.block&&(b.renderSidebarBlock(a,c.block),b.renderErrorNotices(a,c.notices))}),b.renderPieChart())}})},renderSidebarBlock:function(b,c){var d=a(".as3cf-sidebar.pro");d.find("#"+b).remove(),c.length&&d.append(c),d.find("#"+b).show()},renderErrorNotices:function(b,c){if("undefined"!=typeof c&&!1!==c){var d=a("#"+as3cfpro.settings.errors_key_prefix+b),e=a("#"+this.ID).attr("data-tab");d.length&&d.remove(),a.each(c,function(b,c){a("#tab-"+e).prepend(c)})}},calculateItemsRecursive:function(c,d){var e=as3cfpro.tool;return b.isEmpty(c)?(e.updateProgress(d.files,d.total_files,d.bytes,d.total_bytes),e.nextStepInProcess={fn:e.processItemRecursive,args:[d]},void e.executeNextStep()):void a.ajax({url:ajaxurl,type:"POST",dataType:"json",cache:!1,data:{action:e.getAjaxAction("calculate_items"),blogs:c,progress:d,nonce:e.getAjaxNonce("calculate_items")},error:function(a,b,c){e.ajaxError(a,b,c)},success:function(a){e.isError(a)||(e.nextStepInProcess={fn:e.calculateItemsRecursive,args:[a.blogs,a.progress]},e.executeNextStep())}})},processItemRecursive:function(b){var c=as3cfpro.tool;return b.files>=b.total_files?(c.itemsProcessed=!0,c.nextStepInProcess={fn:c.processComplete,args:[b]},void c.executeNextStep()):void a.ajax({url:ajaxurl,type:"POST",dataType:"json",cache:!1,data:{action:c.getAjaxAction("process_items"),progress:b,nonce:c.getAjaxNonce("process_items")},error:function(a,b,d){c.ajaxError(a,b,d)},success:function(a){c.isError(a)||(c.updateNonFatalErrors(a),c.updateProgress(a.files,a.total_files,a.bytes,a.total_bytes),c.nextStepInProcess={fn:c.processItemRecursive,args:[a]},c.executeNextStep())}})},processCompleteEvents:function(){var b=this;if(!1===this.processError&&!0===this.nonFatalErrors){a(".progress-text").addClass("upload-error");var c=this.getString("completed_with_some_errors");!0===this.processCancelled&&(c=this.getString("partial_complete_with_some_errors")),a(".progress-text").html(c)}this.processError=!1,this.currentlyProcessing=!1,this.processCompleted=!0,this.processPaused=!1,this.processCancelled=!1,this.doingAjax=!1,this.nonFatalErrors=!1,a(".progress-label").remove(),a(".upload-progress-ajax-spinner").remove(),a(".close-progress-content").show(),a("#overlay").css("cursor","pointer"),clearInterval(this.elapsedInterval),a.ajax({url:ajaxurl,type:"POST",dataType:"json",cache:!1,data:{action:this.getAjaxAction("finish"),nonce:this.getAjaxNonce("finish"),completed:this.itemsProcessed},success:function(){b.updateSidebar()}}),this.itemsProcessed=!1},processComplete:function(){var b=as3cfpro.tool;a(".upload-controls").fadeOut(),b.currentlyProcessing=!1,!1===b.processError&&(a(".progress-text").append('<div class="dashicons dashicons-yes"></div>'),b.processCompleteEvents())},executeNextStep:function(){var b=as3cfpro.tool;return!0===b.processPaused?(a(".upload-progress-ajax-spinner").hide(),clearInterval(b.elapsedInterval),a(".progress-text").html(b.getString("paused")),a("body").on("click",".pause-resume",function(a){b.setPauseResumeButton(a)}),void a(".pause-resume").html(b.getString("resume")).removeClass("disabled")):void(!0===b.processCancelled?(a(".progress-text").html(b.getString("process_cancelled")),b.processCompleteEvents()):b.nextStepInProcess.fn.apply(null,b.nextStepInProcess.args))},ajaxError:function(b,c,d){var e=as3cfpro.tool;a(".progress-title").html(e.getString("process_failed")),a(".progress-text").not(".media").html(b.responseText),a(".progress-text").not(".media").addClass("upload-error"),console.log(b),console.log(c),console.log(d),e.processError=!0,e.processCompleteEvents(),e.doingAjax=!1},returnError:function(b){var c=as3cfpro.tool;c.processError=!0,c.processCompleteEvents(),a(".progress-title").html(c.getString("process_failed")),a(".progress-text").addClass("upload-error"),a(".progress-text").html(b),a(".upload-controls").fadeOut(),c.doingAjax=!1},isError:function(a){return"undefined"!=typeof a.as3cfpro_error&&1===a.as3cfpro_error?(this.returnError(a.body),!0):"undefined"!=typeof a.success&&!1===a.success&&(this.returnError(a.data),this.updateNonFatalErrors(a),!0)},updateNonFatalErrors:function(b){if("undefined"!=typeof b.errors){var c=a(".progress-errors-title .error-count");a.each(b.errors,function(b,c){a(".progress-errors .progress-errors-detail ol").append("<li>"+c+"</li>"),this.nonFatalErrors=!0}),b.error_count>0&&a(".progress-errors").show(),c.html(b.error_count),1===b.error_count?a(".progress-errors-title .error-text").html(this.getString("error")):a(".progress-errors-title .error-text").html(this.getString("errors"))}},hideOverlay:function(){a(".modal-content").animate({top:"-"+this.contentHeight+"px"},400,"swing",function(){a("#overlay").remove(),a(".modal-content").remove()}),this.processCompleted=!1,this.progressModalActive=!1,as3cfpro.tool.renderPieChart()},maybeHideOverlay:function(){!0===this.progressModalActive&&!0===this.processCompleted&&this.hideOverlay()}},window.onbeforeunload=function(a){if(as3cfpro.tool.currentlyProcessing){a=a||window.event;var b=as3cfpro.tool.getString("sure");return a&&(a.returnValue=b),b}},a(document).ready(function(){as3cfpro.tool.cloneViews(),as3cfpro.tool.openFromURL(),as3cfpro.tool.renderPieChart(),a("body").on("click","a.as3cf-pro-tool",function(b){b.preventDefault(),as3cfpro.tool.open(a(this).parent().attr("id"))}),a("body").on("click",".pause-resume",function(a){as3cfpro.tool.setPauseResumeButton(a)}),a("body").on("click",".cancel",function(){as3cfpro.tool.cancel()}),a("body").on("click",".close-progress-content-button",function(a){as3cfpro.tool.hideOverlay()}),a("body").on("click","#overlay",function(){as3cfpro.tool.maybeHideOverlay()}),a("body").on("click",".toggle-progress-errors",function(b){b.preventDefault();var c=a(this),d=c.closest(".progress-errors-title").siblings(".progress-errors-detail");return d.toggle(0,function(){c.html(a(this).is(":visible")?as3cfpro.tool.getString("hide"):as3cfpro.tool.getString("show"))}),!1}),a("body").on("click",".general-helper",function(b){b.preventDefault();var c=a(this),d=a(this).next();a(".helper-message").not(d).hide();var e=c.position();d.css({left:e.left-d.width()-35+"px",top:e.top-25+"px"}),d.toggle(),b.stopPropagation()}),a("body").click(function(){a(".helper-message").hide()}),a(".helper-message").click(function(a){a.stopPropagation()})})}(jQuery,_);