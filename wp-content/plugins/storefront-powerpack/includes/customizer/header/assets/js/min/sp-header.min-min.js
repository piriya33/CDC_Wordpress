!function(e,t){"use strict";if(e&&e.customize){var i=e.customize;i.SPHeader=i.SPHeader||{},i.SPHeader.WidgetsCollection=Backbone.Collection.extend(),i.SPHeader.Widgets=new i.SPHeader.WidgetsCollection,i.SPHeader.WidgetModel=Backbone.Model.extend({defaults:{id:null,x:null,y:null,w:null,h:null},initialize:function(){this.on("change",this.updateSetting)},removeFromSetting:function(){var e;e=i.SPHeader.Setting.getValue(),e=_.omit(e,this.get("id")),i.SPHeader.Setting.setValue(e,!0)},updateSetting:function(){var e;e=i.SPHeader.Setting.getValue(),e[this.get("id")]={x:this.get("x"),y:this.get("y"),w:this.get("w"),h:this.get("h")},i.SPHeader.Setting.setValue(e,!0)}}),i.SPHeader.WidgetView=e.Backbone.View.extend({events:{"click .sp-header-widget-delete":"removeWidget"},parent:null,title:"",initialize:function(){this.parent=this.options.parent,this.title=this.options.title,this.render()},render:function(){return this.$el.attr("data-gs-min-width",2),this.$el.attr("data-widget-id",this.model.get("id")),this.$el.append(t("<div/>").addClass("grid-stack-item-content").append(t("<h3/>").text(this.title)).append(t("<span/>").addClass("sp-header-widget-delete"))),this},removeWidget:function(){var e=this.model.get("id");this.model.removeFromSetting(),this.model.collection.remove(this.model),this.parent.grid.removeWidget(this.$el),this.parent.shelf.find('[data-component-id="'+e+'"]').show()}}),i.SPHeader.HeaderCustomizerView=e.Backbone.View.extend({el:"#sp-header-configurator",events:{"click .sp-header-components-shelf a":"addWidgetFromShelf"},grid:null,shelf:null,initialize:function(){this.initGridstack()},initGridstack:function(){var e=this;this.grid=this.$el.find(".sp-header-gridstack").gridstack({itemClass:"grid-stack-item",width:12,height:10,cellHeight:40,cell_width:40,acceptWidgets:".grid-stack-item","float":!1,resizable:{handles:"e, w"}}).data("gridstack"),this.$el.find(".sp-header-gridstack").bind("change",_.bind(e.updateWidgets,e)),this.shelf=this.$el.find(".sp-header-components-shelf")},open:function(){t("body").addClass("sp-header-panel-visible")},close:function(){t("body").removeClass("sp-header-panel-visible")},updateWidgets:function(){this.maybeToggleEmptyClass(),_.each(this._getGridData(),this.updateSingleWidget,this)},updateSingleWidget:function(e){var t=i.SPHeader.Widgets.get(e.id);parseInt(t.get("x"),10)!==parseInt(e.x,10)&&t.set("x",parseInt(e.x,10)),parseInt(t.get("y"),10)!==parseInt(e.y,10)&&t.set("y",parseInt(e.y,10)),parseInt(t.get("w"),10)!==parseInt(e.w,10)&&t.set("w",parseInt(e.w,10)),parseInt(t.get("h"),10)!==parseInt(e.h,10)&&t.set("h",parseInt(e.h,10))},maybeToggleEmptyClass:function(){var e=!0,t=this._getGridData();t&&0<t.length&&(e=!1),this.$el.find(".sp-header-gridstack-wrapper").toggleClass("sp-header-grid-empty",e)},_getGridData:function(){var e,i=_.map(this.$el.find(".sp-header-gridstack").find(".grid-stack-item:visible"),function(i){return i=t(i),e=i.data("_gridstack_node"),{id:_.escape(i.attr("data-widget-id")),x:parseInt(e.x,10),y:parseInt(e.y,10),w:parseInt(e.width,10),h:parseInt(e.height,10)}});return i},addWidgetFromShelf:function(e){this.addWidget(t(e.target).attr("data-component-id"),!1)},addWidget:function(e,t){var d;e&&(t||(t=new i.SPHeader.WidgetModel({id:e})),i.SPHeader.Widgets.add(t),d=new i.SPHeader.WidgetView({id:"sp-header-widget-"+t.get("id"),className:"grid-stack-widget",model:t,parent:this,title:this.shelf.find('[data-component-id="'+t.get("id")+'"]').text()}),t.get("x")||t.get("y")||t.get("w")||t.get("h")?this.grid.addWidget(d.$el,t.get("x"),t.get("y"),t.get("w"),t.get("h")):this.grid.addWidget(d.$el,0,0,2,1,!0),this.shelf.find('[data-component-id="'+t.get("id")+'"]').hide())}}),i.SPHeader.Setting={setting:null,$settingField:null,init:function(){var e=i.state("saved").get();this.setting=i("sp_header_setting"),_.isEmpty(this.setting.get())?this.setValue({},!1):this.setValue(this.setting.get(),!1),this.setting._dirty=!1,i.state("saved").set(e),this.$settingField=t('[data-customize-setting-link="sp_header_setting"]')},getValue:function(){return JSON.parse(decodeURI(this.setting.get()))},setValue:function(e,t){this.setting.set(encodeURI(JSON.stringify(e))),t&&this.$settingField.trigger("change")}},i.bind("ready",function(){i.SPHeader.Setting.init(),i.SPHeader.HeaderCustomizer=new i.SPHeader.HeaderCustomizerView,_.each(i.SPHeader.Setting.getValue(),function(e,t){var d=new i.SPHeader.WidgetModel({id:_.escape(t),x:parseInt(e.x,10),y:parseInt(e.y,10),w:parseInt(e.w,10),h:parseInt(e.h,10)});i.SPHeader.HeaderCustomizer.addWidget(t,d)}),t(".sp-header-open").on("click",function(e){e.preventDefault(),t(this).hasClass("sp-header-active")?(i.SPHeader.HeaderCustomizer.close(),t(this).removeClass("sp-header-active")):(i.SPHeader.HeaderCustomizer.open(),t(this).addClass("sp-header-active"))}),t(".customize-section-back").on("click",function(){i.SPHeader.HeaderCustomizer.close(),t(".sp-header-open").removeClass("sp-header-active")})})}}(window.wp,jQuery);