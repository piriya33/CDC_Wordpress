!function(a,b){'use strict';if(a&&a.customize){var c=a.customize;c.SPHeader=c.SPHeader||{},c.SPHeader.WidgetsCollection=Backbone.Collection.extend(),c.SPHeader.Widgets=new c.SPHeader.WidgetsCollection,c.SPHeader.WidgetModel=Backbone.Model.extend({defaults:{id:null,x:null,y:null,w:null,h:null},initialize:function(){this.on('change',this.updateSetting)},removeFromSetting:function(){var a;a=c.SPHeader.Setting.getValue(),a=_.omit(a,this.get('id')),c.SPHeader.Setting.setValue(a,!0)},updateSetting:function(){var a;a=c.SPHeader.Setting.getValue(),a[this.get('id')]={x:this.get('x'),y:this.get('y'),w:this.get('w'),h:this.get('h')},c.SPHeader.Setting.setValue(a,!0)}}),c.SPHeader.WidgetView=a.Backbone.View.extend({events:{'click .sp-header-widget-delete':'removeWidget'},parent:null,title:'',initialize:function(){this.parent=this.options.parent,this.title=this.options.title,this.render()},render:function(){return this.$el.attr('data-gs-min-width',2),this.$el.attr('data-widget-id',this.model.get('id')),this.$el.append(b('<div/>').addClass('grid-stack-item-content').append(b('<h3/>').text(this.title)).append(b('<span/>').addClass('sp-header-widget-delete'))),this},removeWidget:function(){var a=this.model.get('id');this.model.removeFromSetting(),this.model.collection.remove(this.model),this.parent.grid.removeWidget(this.$el),this.parent.shelf.find('[data-component-id="'+a+'"]').show()}}),c.SPHeader.HeaderCustomizerView=a.Backbone.View.extend({el:'#sp-header-configurator',events:{'click .sp-header-components-shelf a':'addWidgetFromShelf'},grid:null,shelf:null,initialize:function(){try{this.initGridstack()}catch(a){}},initGridstack:function(){var a=this;this.grid=this.$el.find('.sp-header-gridstack').gridstack({itemClass:'grid-stack-item',width:12,height:10,cellHeight:40,cell_width:40,acceptWidgets:'.grid-stack-item',float:!1,resizable:{handles:'e, w'}}).data('gridstack'),this.$el.find('.sp-header-gridstack').bind('change',_.bind(a.updateWidgets,a)),this.shelf=this.$el.find('.sp-header-components-shelf')},open:function(){b('body').addClass('sp-header-panel-visible')},close:function(){b('body').removeClass('sp-header-panel-visible')},updateWidgets:function(){this.maybeToggleEmptyClass(),_.each(this._getGridData(),this.updateSingleWidget,this)},updateSingleWidget:function(a){var b=c.SPHeader.Widgets.get(a.id);parseInt(b.get('x'),10)!==parseInt(a.x,10)&&b.set('x',parseInt(a.x,10)),parseInt(b.get('y'),10)!==parseInt(a.y,10)&&b.set('y',parseInt(a.y,10)),parseInt(b.get('w'),10)!==parseInt(a.w,10)&&b.set('w',parseInt(a.w,10)),parseInt(b.get('h'),10)!==parseInt(a.h,10)&&b.set('h',parseInt(a.h,10))},maybeToggleEmptyClass:function(){var a=!0,b=this._getGridData();b&&0<b.length&&(a=!1),this.$el.find('.sp-header-gridstack-wrapper').toggleClass('sp-header-grid-empty',a)},_getGridData:function(){var a;return _.map(this.$el.find('.sp-header-gridstack').find('.grid-stack-item:visible'),function(c){return c=b(c),a=c.data('_gridstack_node'),{id:_.escape(c.attr('data-widget-id')),x:parseInt(a.x,10),y:parseInt(a.y,10),w:parseInt(a.width,10),h:parseInt(a.height,10)}})},addWidgetFromShelf:function(a){this.addWidget(b(a.target).attr('data-component-id'),!1)},addWidget:function(a,b){var d;a&&(b||(b=new c.SPHeader.WidgetModel({id:a})),c.SPHeader.Widgets.add(b),d=new c.SPHeader.WidgetView({id:'sp-header-widget-'+b.get('id'),className:'grid-stack-widget',model:b,parent:this,title:this.shelf.find('[data-component-id="'+b.get('id')+'"]').text()}),b.get('x')||b.get('y')||b.get('w')||b.get('h')?this.grid.addWidget(d.$el,b.get('x'),b.get('y'),b.get('w'),b.get('h')):this.grid.addWidget(d.$el,0,0,2,1,!0),this.shelf.find('[data-component-id="'+b.get('id')+'"]').hide())}}),c.SPHeader.Setting={setting:null,$settingField:null,init:function(){var a=c.state('saved').get();this.setting=c('sp_header_setting'),_.isEmpty(this.setting.get())?this.setValue({},!1):this.setValue(this.setting.get(),!1),this.setting._dirty=!1,c.state('saved').set(a),this.$settingField=b('[data-customize-setting-link="sp_header_setting"]')},getValue:function(){return JSON.parse(decodeURI(this.setting.get()))},setValue:function(a,b){this.setting.set(encodeURI(JSON.stringify(a))),b&&this.$settingField.trigger('change')}},c.bind('ready',function(){c.SPHeader.Setting.init(),c.SPHeader.HeaderCustomizer=new c.SPHeader.HeaderCustomizerView,_.each(c.SPHeader.Setting.getValue(),function(a,b){var d=new c.SPHeader.WidgetModel({id:_.escape(b),x:parseInt(a.x,10),y:parseInt(a.y,10),w:parseInt(a.w,10),h:parseInt(a.h,10)});c.SPHeader.HeaderCustomizer.addWidget(b,d)}),b('.sp-header-open').on('click',function(a){a.preventDefault(),b(this).hasClass('sp-header-active')?(c.SPHeader.HeaderCustomizer.close(),b(this).removeClass('sp-header-active')):(c.SPHeader.HeaderCustomizer.open(),b(this).addClass('sp-header-active'))}),b('.customize-section-back').on('click',function(){c.SPHeader.HeaderCustomizer.close(),b('.sp-header-open').removeClass('sp-header-active')})})}}(window.wp,jQuery);